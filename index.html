<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2325/2325592.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Reservation Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        html, body {
            height: 100%; margin: 0; background-color: #f1f5f9;
            overflow: hidden; display: flex; flex-direction: column;
        }
        header { flex-shrink: 0; z-index: 50; position: sticky; top: 0; }
        .board-container { 
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 15px; padding: 10px; flex-grow: 1; min-height: 0; 
        }
        .column-scroll-wrapper { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .scroll-inner {
            flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; 
            padding: 10px 15px;
        }
        .kanban-column { min-height: 150px; padding-bottom: 100px; }
        .guest-card { 
            cursor: grab; margin-bottom: 15px; border-radius: 12px; 
            padding: 12px !important; box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0; background: white; touch-action: none;
        }
        .status-completed, .status-cancelled { display: none; opacity: 0.5; filter: grayscale(1); }
        body.show-finished .status-completed, body.show-finished .status-cancelled { display: block !important; }
        .guest-card.hidden-search { display: none !important; }
        .status-pending { border-left: 8px solid #94a3b8; }
        .status-confirmed { border-left: 8px solid #3b82f6; } 
        .status-seated { border-left: 8px solid #22c55e; }    
        .status-completed { border-left: 8px solid #64748b; } 
        .status-cancelled { border-left: 8px solid #ef4444; } 
        .large-party-alert { border: 2px solid #ef4444 !important; background-color: #fff1f2 !important; }
        .table-box { 
            border: 2px solid #cbd5e1; border-radius: 14px; 
            background: white; padding: 12px; margin-bottom: 18px; 
        }
        .table-label { font-size: 12px; font-weight: 900; color: #475569; margin-bottom: 6px; text-transform: uppercase; }
        #announcementBox { text-align: center; resize: none; border-radius: 12px; height: 50px; }
    </style>
</head>
<body>

    <header class="flex justify-between items-center p-3 bg-white shadow-sm border-b border-slate-200">
        <div class="flex items-center gap-4">
            <h1 class="font-black italic text-slate-800 text-xl tracking-tighter uppercase">RESERVATIONS</h1>
            <input type="date" id="datePicker" class="border-2 border-slate-100 p-1 rounded-lg font-bold text-blue-600 outline-none text-sm">
        </div>
        <div class="flex gap-2">
            <span id="totalCovers" class="text-[10px] font-black text-slate-500 bg-slate-100 px-3 py-2 rounded-full uppercase">0 GUESTS</span>
            <div class="flex border rounded-lg overflow-hidden border-slate-200 shadow-sm">
                <button onclick="downloadBackup()" class="bg-white hover:bg-slate-50 text-slate-600 px-3 py-1 text-[10px] font-black uppercase border-r">Backup</button>
                <button onclick="triggerRestore()" class="bg-white hover:bg-slate-50 text-blue-600 px-3 py-1 text-[10px] font-black uppercase">Restore</button>
                <input type="file" id="restoreInput" class="hidden" accept=".json" onchange="handleRestore(this)">
            </div>
            <button onclick="openModal()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-black text-xs uppercase shadow-lg">+ New</button>
        </div>
    </header>

    <div class="notes-area px-3 pt-2">
        <textarea id="announcementBox" oninput="saveAnnounce()" placeholder="â€” DAILY NOTES â€”" 
        class="w-full bg-amber-50 border-2 border-amber-100 p-2 text-xs font-bold text-amber-900 uppercase outline-none focus:border-amber-300 shadow-inner"></textarea>
    </div>

    <div class="board-container">
        <div class="column-scroll-wrapper">
            <div class="text-[10px] font-black text-blue-600 text-center uppercase mb-2 bg-blue-100/50 py-1.5 rounded-lg border border-blue-200">Zone A</div>
            <div class="scroll-inner">
                <div class="table-box"><div class="table-label">A1</div><div id="A1" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">A2</div><div id="A2" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">A3</div><div id="A3" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">A6</div><div id="A6" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">A7</div><div id="A7" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">A8</div><div id="A8" class="kanban-column"></div></div>
            </div>
        </div>

        <div class="column-scroll-wrapper bg-slate-200/50 p-3 rounded-2xl border border-slate-300 shadow-inner">
            <div class="shrink-0 space-y-2 mb-3">
                <input type="text" id="searchInput" oninput="searchGuests()" placeholder="ðŸ” SEARCH..." class="w-full p-3 rounded-xl border-2 border-slate-200 text-sm font-bold uppercase outline-none focus:border-blue-500">
                <div class="flex items-center justify-between px-1">
                    <button onclick="sortArrivals()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase">Sort Time â†“</button>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showFinishedToggle" onchange="toggleFinished(this)" class="w-5 h-5">
                        <span class="text-[9px] font-black text-slate-500 uppercase">Show Done</span>
                    </label>
                </div>
            </div>
            <div class="scroll-inner">
                <div id="unassigned" class="kanban-column bg-white/40 rounded-xl p-2"></div>
            </div>
            <div class="mt-3 shrink-0 space-y-2">
                <button onclick="resetToArrivals()" class="w-full bg-slate-800 text-white py-4 rounded-2xl text-[11px] font-black uppercase shadow-md">Reset All â†©</button>
                <button onclick="clearDay()" class="w-full text-[9px] text-slate-400 font-bold uppercase underline text-center pb-2">Clear Today</button>
            </div>
        </div>

        <div class="column-scroll-wrapper">
            <div class="text-[10px] font-black text-emerald-600 text-center uppercase mb-2 bg-emerald-100/50 py-1.5 rounded-lg border border-emerald-200">Zone B</div>
            <div class="scroll-inner">
                <div class="table-box"><div class="table-label">B1</div><div id="B1" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">B2</div><div id="B2" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">B3A</div><div id="B3A" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">B4A</div><div id="B4A" class="kanban-column"></div></div>
                <div class="table-box"><div class="table-label">B5</div><div id="B5" class="kanban-column"></div></div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/70 hidden flex items-start justify-center z-[100] p-4 pt-10 backdrop-blur-md overflow-y-auto">
        <div class="bg-white p-6 rounded-3xl w-full max-w-[400px] shadow-2xl mb-10">
            <h2 id="modalTitle" class="text-lg font-black mb-4 uppercase text-slate-800">Booking Info</h2>
            <input type="hidden" id="editCardId">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Time</label><input type="time" id="newTime" class="w-full border-2 border-slate-100 p-3 rounded-xl text-lg font-bold outline-none focus:border-blue-500"></div>
                    <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Pax</label><input type="number" id="newSize" class="w-full border-2 border-slate-100 p-3 rounded-xl text-lg font-bold outline-none focus:border-blue-500"></div>
                </div>
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Name</label><input type="text" id="newName" class="w-full border-2 border-slate-100 p-3 rounded-xl font-black uppercase"></div>
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Phone</label><input type="text" id="newPhone" class="w-full border-2 border-slate-100 p-3 rounded-xl"></div>
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Requests</label><textarea id="newReq" class="w-full border-2 border-slate-100 p-3 rounded-xl h-20 text-xs"></textarea></div>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeModal()" class="flex-1 py-4 text-xs font-black text-slate-400 uppercase">Cancel</button>
                    <button onclick="saveBooking()" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-lg">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ids = ['unassigned', 'A1', 'A2', 'A3', 'A6', 'A7', 'A8', 'B1', 'B2', 'B3A', 'B4A', 'B5'];
        const picker = document.getElementById('datePicker');
        picker.value = new Date().toISOString().split('T')[0];

        // Ensure Sortable targets the ID containers inside the scroll-inner
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                new Sortable(el, { 
                    group: 'floor', animation: 150, delay: 100, touchStartThreshold: 15, onEnd: save 
                });
            }
        });

        function triggerRestore() { document.getElementById('restoreInput').click(); }
        function handleRestore(input) {
            const file = input.files[0];
            if (!file) return;
            if (!confirm("Overwrite current data?")) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.b) localStorage.setItem('rest_v24', data.b);
                    if (data.m) localStorage.setItem('rest_v24_meta', data.m);
                    location.reload(); 
                } catch (err) { alert("Error reading backup."); }
            };
            reader.readAsText(file);
        }

        function openModal(editData = null) {
            document.getElementById('modal').classList.remove('hidden');
            if (editData) {
                document.getElementById('editCardId').value = editData.id;
                document.getElementById('newName').value = editData.name;
                document.getElementById('newSize').value = editData.size;
                document.getElementById('newTime').value = editData.time;
                document.getElementById('newPhone').value = editData.phone;
                document.getElementById('newReq').value = editData.req;
            } else {
                document.getElementById('editCardId').value = "";
                document.getElementById('newName').value = "";
                document.getElementById('newSize').value = "";
                document.getElementById('newTime').value = "18:00";
                document.getElementById('newPhone').value = "";
                document.getElementById('newReq').value = "";
            }
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveBooking() {
            const editId = document.getElementById('editCardId').value;
            const data = {
                name: (document.getElementById('newName').value || 'Guest').toUpperCase(),
                size: document.getElementById('newSize').value || '?',
                time: document.getElementById('newTime').value || '18:00',
                phone: document.getElementById('newPhone').value || '-',
                req: document.getElementById('newReq').value || '',
                status: 'pending'
            };
            if (editId) {
                const oldCard = document.querySelector(`[data-id="${editId}"]`);
                data.status = oldCard.dataset.status;
                const containerId = oldCard.parentElement.id;
                oldCard.remove();
                renderCard(containerId, data, editId);
            } else {
                renderCard('unassigned', data);
            }
            save(); closeModal();
        }

        function renderCard(containerId, data, existingId = null) {
            const container = document.getElementById(containerId);
            if(!container) return;
            const div = document.createElement('div');
            const id = existingId || Date.now().toString();
            const isLarge = parseInt(data.size) >= 5;
            div.className = `guest-card status-${data.status} ${isLarge ? 'large-party-alert' : ''}`;
            div.dataset.id = id;
            Object.assign(div.dataset, data);
            div.innerHTML = `
                <div onclick="editCard('${id}')">
                    <div class="flex justify-between font-black text-[11px] mb-1">
                        <span>${data.time}</span> 
                        <span class="${isLarge ? 'text-red-600' : 'text-blue-600'}">${data.size}P</span>
                    </div>
                    <div class="text-[14px] font-black uppercase truncate">${data.name}</div>
                    <div class="text-[11px] text-slate-500 font-bold">${data.phone}</div>
                    ${data.req ? '<div class="text-[10px] text-slate-400 italic mt-2 border-t pt-1">â˜… '+data.req+'</div>' : ''}
                </div>
                <div class="flex gap-1 mt-3">
                    <button onclick="toggleStatus(this)" class="flex-1 text-[8px] font-black border border-current rounded-md py-2 uppercase">${data.status.toUpperCase()}</button>
                    <button onclick="confirmCardDelete(this)" class="text-slate-300 px-3 text-xl">Ã—</button>
                </div>
            `;
            container.appendChild(div);
        }

        function toggleStatus(btn) {
            const card = btn.closest('.guest-card');
            const states = ['pending', 'confirmed', 'seated', 'completed', 'cancelled'];
            let nextStatus = states[(states.indexOf(card.dataset.status) + 1) % states.length];
            if (['completed', 'cancelled'].includes(nextStatus) && !confirm(`Mark ${nextStatus}?`)) return;
            card.dataset.status = nextStatus;
            card.className = `guest-card status-${nextStatus} ${parseInt(card.dataset.size) >= 5 ? 'large-party-alert' : ''}`;
            btn.innerText = nextStatus.toUpperCase();
            save();
        }

        function editCard(id) { const card = document.querySelector(`[data-id="${id}"]`); openModal({...card.dataset}); }
        function sortArrivals() {
            const list = document.getElementById('unassigned');
            const items = Array.from(list.children);
            items.sort((a, b) => a.dataset.time.localeCompare(b.dataset.time));
            items.forEach(item => list.appendChild(item));
            save();
        }
        function resetToArrivals() {
            if(confirm("Move all back to Arrivals?")) {
                const arrivals = document.getElementById('unassigned');
                ids.forEach(id => {
                    if (id !== 'unassigned') {
                        const col = document.getElementById(id);
                        while (col.firstChild) arrivals.appendChild(col.firstChild);
                    }
                });
                save(); sortArrivals();
            }
        }
        function searchGuests() {
            const q = document.getElementById('searchInput').value.trim().toUpperCase();
            document.querySelectorAll('.guest-card').forEach(c => {
                const s = (c.dataset.name + c.dataset.phone).toUpperCase();
                c.classList.toggle('hidden-search', q !== "" && !s.includes(q));
            });
        }
        function toggleFinished(cb) { document.body.classList.toggle('show-finished', cb.checked); }
        function confirmCardDelete(btn) { if(confirm("Delete?")) { btn.closest('.guest-card').remove(); save(); } }
        function saveAnnounce() {
            const meta = JSON.parse(localStorage.getItem('rest_v24_meta') || '{}');
            meta[picker.value] = document.getElementById('announcementBox').value;
            localStorage.setItem('rest_v24_meta', JSON.stringify(meta));
        }
        function save() {
            const state = {}; let total = 0;
            ids.forEach(id => {
                const col = document.getElementById(id);
                if(col) {
                    state[id] = Array.from(col.querySelectorAll('.guest-card')).map(c => {
                        if (['pending', 'confirmed', 'seated'].includes(c.dataset.status)) total += parseInt(c.dataset.size) || 0;
                        return {...c.dataset};
                    });
                }
            });
            const db = JSON.parse(localStorage.getItem('rest_v24') || '{}');
            db[picker.value] = state;
            localStorage.setItem('rest_v24', JSON.stringify(db));
            document.getElementById('totalCovers').innerText = `${total} GUESTS`;
        }
        function load() {
            const db = JSON.parse(localStorage.getItem('rest_v24') || '{}');
            const meta = JSON.parse(localStorage.getItem('rest_v24_meta') || '{}');
            ids.forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ''; });
            document.getElementById('announcementBox').value = meta[picker.value] || '';
            const day = db[picker.value];
            if (day) Object.keys(day).forEach(id => day[id].forEach(g => renderCard(id, g, g.id)));
            save();
        }
        function downloadBackup() {
            const blob = new Blob([JSON.stringify({b: localStorage.getItem('rest_v24'), m: localStorage.getItem('rest_v24_meta')})], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Reservations_Backup.json`; a.click();
        }
        function clearDay() { if(confirm("Wipe Today?")) { ids.forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ''; }); save(); } }
        picker.addEventListener('change', load);
        window.onload = load;
    </script>
</body>
</html>
